<!DOCTYPE html>
<html>
<head>
  <title>Manitoba Angler Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "urrseiyu43");
  </script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>

  <style>
    :root {
      --teal-700: #0f766e;
      --teal-500: #14b8a6;
      --amber-400: #fbbf24;
    }
    body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    #map { position: absolute; top: 80px; bottom: 60px; width: 100%; z-index: 1; }
    
    /* Unified Header Styles */
    .site-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, var(--teal-700) 0%, var(--teal-500) 100%);
      color: white;
      padding: 1rem;
      z-index: 1100;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .site-branding {
      flex: 1;
      min-width: 200px;
    }

    .site-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
    }

    .site-title a {
      color: white;
      text-decoration: none;
    }

    .site-tagline {
      margin: 0.25rem 0 0 0;
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .site-nav {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .nav-link {
      color: white;
      text-decoration: none;
      font-weight: 600;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      background: rgba(255,255,255,0.1);
      transition: background-color 0.2s;
    }

    .nav-link:hover {
      background: rgba(255,255,255,0.2);
    }

    .nav-link.active {
      background: rgba(255,255,255,0.3);
    }

    /* Style for the floating filter box */
    #ui-controls {
      position: absolute;
      top: 100px;
      right: 20px;
      z-index: 1000;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    select {
      font-size: 16px;
      padding: 5px;
      width: 200px;
    }

    /* Unified Footer Styles */
    .site-footer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1100;
      text-align: center;
      padding: 1rem;
      background: linear-gradient(135deg, var(--teal-700) 0%, var(--teal-500) 100%);
      color: white;
      font-size: 0.85rem;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
    }

    .site-footer a {
      color: var(--amber-400);
      text-decoration: none;
    }

    .site-footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

<header class="site-header">
  <div class="header-container">
    <div class="site-branding">
      <h1 class="site-title"><a href="index.html">üé£ Manitoba Fishing Tips</a></h1>
      <p class="site-tagline">Your Complete Fishing Resource</p>
    </div>
    <nav class="site-nav" aria-label="Main navigation">
      <a href="index.html" class="nav-link">Home</a>
      <a href="FieldGuide.html" class="nav-link">Field Guide</a>
      <a href="AnglerMap.html" class="nav-link active">Angler Map</a>
    </nav>
  </div>
</header>

<div id="ui-controls">
  <label for="species"><b>Choose Target Species:</b></label><br><br>
  <select id="species">
    <option value="1=1">Show All Lakes</option>
    <option value="SPECIES LIKE '%Walleye%'">Walleye</option>
    <option value="SPECIES LIKE '%Northern %'">Northern Pike</option>
    <option value="SPECIES LIKE '%Yellow Perch%'">Yellow Perch</option>
    <option value="SPECIES LIKE '%Smallmouth Bass%'">Smallmouth Bass</option>
    <option value="SPECIES LIKE '%Lake Whitefish%'">Lake Whitefish</option>
    <option value="SPECIES LIKE '%Goldeye%'">Goldeye (Red River Area)</option>
    <option value="SPECIES LIKE '%Sauger%'">Sauger</option>
    <option value="SPECIES LIKE '%Burbot%'">Burbot (Mariah)</option>
    <option value="SPECIES LIKE '%Freshwater Drum%'">Freshwater Drum</option>
    <option value="SPECIES LIKE '%Trout%'">Trout (Lake, Brook, etc.)</option>
    <option value="SPECIES LIKE '%Bullhead%'">Brown Bullhead</option>
    <option value="SPECIES LIKE '%Crappie%'">Black Crappie</option>
    <option value="SPECIES LIKE '%Bluegill%'">Bluegill</option>
  </select>
</div>

<div id="map"></div>
<script>
    // Manitoba Waterbody Stocking Records Feature Service
    // const waterbodyUrl = "https://services.arcgis.com/mMUesHYPkXjaFGfS/arcgis/rest/services/Manitoba_Waterbody_Stocking_Records/FeatureServer/0";

    // Manitoba Waterbody Data Feature Service
    const waterbodyUrl = "https://services.arcgis.com/mMUesHYPkXjaFGfS/arcgis/rest/services/Manitoba_Waterbody_Data/FeatureServer/0";

</script>

<script>
  // 1. Initialize Map
  const map = L.map('map').setView([51.6, -99], 8)// Centered to show the split

  // 2. Add Base Map
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  // --- LOGIC: Color coding with Special Areas ---
  function getDivisionColor(props) {
    const div = (props.FISHING_DIVISION || '').toUpperCase();
    // The field name for Special Area is usually 'SPECIAL_AREA' or 'Special_Area'
    // We check both just to be safe with the API data
    const special = (props.SPECIAL_AREA || props.Special_Area || '').toUpperCase();

    // 1. Handle SOUTHERN DIVISION Hierarchy
    if (div.includes('SOUTH')) {
      if (special.includes('AREA A')) return '#E69F00'; // Orange (Area A)
      if (special.includes('AREA B')) return '#CC79A7'; // Reddish Purple (Area B)
      return '#D55E00'; // Vermilion (Southern General)
    }

    // 2. Handle NORTHERN DIVISIONS
    if (div.includes('NORTH CENTRAL')) return '#56B4E9'; // Blue
    if (div.includes('NORTHEAST'))     return '#009E73'; // Teal
    if (div.includes('NORTHWEST'))     return '#0072B2'; // Blue

    return '#7F7F7F'; // Grey (Unknown)
  }

  // 3. Define the Manitoba Data Layer
  // const waterbodyUrl = "https://geoportal.gov.mb.ca/server/rest/services/Public/Manitoba_Waterbody_Data/FeatureServer/0";

  const fishingLayer = L.esri.featureLayer({
    url: waterbodyUrl,
    where: "1=1",
    
    pointToLayer: function (geojson, latlng) {
      // Pass the *whole* properties object to our color function
      const color = getDivisionColor(geojson.properties);

      return L.circleMarker(latlng, {
        color: '#2c3e50',
        fillColor: color,
        fillOpacity: 0.8,
        radius: 6,
        weight: 1
      });
    }
  }).addTo(map);

  // 4. Add Popups (Now showing Special Area info)
  fishingLayer.bindPopup(function (layer) {
    const props = layer.feature.properties;
    const specialArea = props.SPECIAL_AREA || props.Special_Area || '';
    
    // Create a warning note if it's a special area
    let areaNote = '';
    if (specialArea) {
      areaNote = `<br><strong style="color:red">‚ö†Ô∏è ${specialArea} Regulations Apply</strong>`;
    }

    return `
      <div style="font-size:14px">
        <b>${props.WATERBODY_NAME}</b><br>
        <span style="color:gray">${props.FISHING_DIVISION}</span>
        ${areaNote}
        <hr style="margin: 5px 0;">
        Fish: <i>${props.SPECIES || 'Not listed'}</i><br>
      </div>
    `;
  });

  // 4. Connect Dropdown to the Map
  const speciesSelect = document.getElementById('species');

  speciesSelect.addEventListener('change', function() {
    // Get the SQL query from the dropdown value
    const newQuery = speciesSelect.value;
    
    // Tell the map layer to update its filter
    fishingLayer.setWhere(newQuery);

  });

  // 5. Updated Legend
  const legend = L.control({position: 'bottomright'});
  legend.onAdd = function (map) {
      const div = L.DomUtil.create('div', 'info legend');
      div.style.background = 'white';
      div.style.padding = '10px';
      div.style.borderRadius = '5px';
      div.style.boxShadow = '0 0 15px rgba(0,0,0,0.2)';
      div.style.lineHeight = '1.5em';

      div.innerHTML = `
        <b>Fishing Regulations</b><br>
        <hr style="margin:5px 0">
        <b>Southern Division</b><br>
        <i style="background:#D55E00; width:10px; height:10px; display:inline-block;"></i> General<br>
        <i style="background:#E69F00; width:10px; height:10px; display:inline-block;"></i> Area A<br>
        <i style="background:#CC79A7; width:10px; height:10px; display:inline-block;"></i> Area B<br>
        <hr style="margin:5px 0">
        <b>Northern Divisions</b><br>
        <i style="background:#56B4E9; width:10px; height:10px; display:inline-block;"></i> North Central<br>
        <i style="background:#0072B2; width:10px; height:10px; display:inline-block;"></i> Northwest<br>
        <i style="background:#009E73; width:10px; height:10px; display:inline-block;"></i> Northeast<br>
      `;
      return div;
  };
  legend.addTo(map);

</script>

<footer class="site-footer">
  <p><strong>üé£ Manitoba Fishing Tips</strong> | ¬© 2025 <a href="https://chefbig.ca">chefbig.ca</a> | 
  <a href="https://www.gov.mb.ca/nrnd/fish-wildlife/pubs/fish_wildlife/fish/angling-guide.pdf" target="_blank" rel="noopener noreferrer">Official Manitoba Angling Guide</a></p>
</footer>

</body>
</html>